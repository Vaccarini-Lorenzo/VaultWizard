"use strict";var d=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var x=Object.prototype.hasOwnProperty;var D=(s,e)=>{for(var t in e)d(s,t,{get:e[t],enumerable:!0})},P=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of L(e))!x.call(s,i)&&i!==t&&d(s,i,{get:()=>e[i],enumerable:!(r=E(e,i))||r.enumerable});return s};var k=s=>P(d({},"__esModule",{value:!0}),s);var A={};D(A,{default:()=>m});module.exports=k(A);var u=require("obsidian");var o="obsidian-ai-helper-chat-view";var y=require("obsidian");var v=require("obsidian");function f(s,e){let t=s.createDiv({cls:"ai-helper-header"});t.createEl("h3",{text:"AI Helper",cls:"ai-helper-title"});let r=t.createEl("button",{cls:"ai-helper-icon-btn"});r.setAttribute("aria-label","Toggle debug panel"),(0,v.setIcon)(r,"bug"),r.addEventListener("click",e)}function b(s,e){let t=s.createDiv({cls:"ai-helper-message-list"});for(let r of e)t.createDiv({cls:`ai-helper-message ai-helper-${r.role}`}).createDiv({cls:"ai-helper-message-content",text:r.content});t.scrollTop=t.scrollHeight}function C(s,e,t){let r=s.createDiv({cls:"ai-helper-composer"}),i=r.createEl("textarea",{cls:"ai-helper-input",attr:{placeholder:"Type message (/c for current note content)..."}}),n=r.createEl("button",{cls:"ai-helper-send-btn",text:t?"...":"Send"});n.disabled=t;let c=async()=>{let a=i.value;i.value="",await e(a)};n.addEventListener("click",c),i.addEventListener("keydown",async a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),await c())})}function w(s,e){let t=s.createDiv({cls:"ai-helper-debug-wrap"}),r=t.createDiv({cls:"ai-helper-header"});r.createEl("h3",{text:"Debug",cls:"ai-helper-title"}),r.createEl("button",{cls:"ai-helper-icon-btn",text:"Back"}).addEventListener("click",()=>e.toggleDebug());let n=t.createEl("pre",{cls:"ai-helper-debug-pre"}),c={messageCount:e.getMessages().length,streaming:e.isStreaming(),activeNotePath:e.getActiveNotePath()};n.textContent=JSON.stringify(c,null,2)}var l=class extends y.ItemView{constructor(t,r){super(t);this.controller=r}getViewType(){return o}getDisplayText(){return"AI Helper Chat"}getIcon(){return"bot"}async onOpen(){this.unsubscribe=this.controller.subscribe(()=>this.render()),this.render()}async onClose(){this.unsubscribe?.()}render(){let{contentEl:t}=this;if(t.empty(),t.addClass("ai-helper-root"),this.controller.isDebugVisible()){w(t,this.controller);return}f(t,()=>this.controller.toggleDebug()),b(t,this.controller.getMessages()),C(t,async r=>this.controller.onUserMessage(r),this.controller.isStreaming())}};var p=class{constructor(e){this.app=e}async getActiveNoteContent(){let e=this.app.workspace.getActiveFile();return e?this.app.vault.cachedRead(e):"No active note is open."}getActiveNotePath(){return this.app.workspace.getActiveFile()?.path??"(none)"}};var h=class{async streamEcho(e,t){let r=`echo: ${e}`;for(let i=0;i<r.length;i+=3)t(r.slice(i,i+3)),await this.sleep(35)}sleep(e){return new Promise(t=>window.setTimeout(t,e))}};var g=class{constructor(e,t){this.noteService=e;this.chatService=t;this.listeners=new Set;this.messages=[];this.debugVisible=!1;this.streaming=!1}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}getMessages(){return this.messages}isDebugVisible(){return this.debugVisible}isStreaming(){return this.streaming}getActiveNotePath(){return this.noteService.getActiveNotePath()}toggleDebug(){this.debugVisible=!this.debugVisible,this.notify()}async onUserMessage(e){let t=e.trim();if(!t||this.streaming)return;if(t==="/c"){let i=await this.noteService.getActiveNoteContent();this.messages.push({role:"assistant",content:i,timestamp:Date.now()}),this.notify();return}this.messages.push({role:"user",content:t,timestamp:Date.now()});let r={role:"assistant",content:"",timestamp:Date.now()};this.messages.push(r),this.streaming=!0,this.notify(),await this.chatService.streamEcho(t,i=>{r.content+=i,this.notify()}),this.streaming=!1,this.notify()}notify(){for(let e of this.listeners)e()}};var m=class extends u.Plugin{async onload(){let e=new p(this.app),t=new h;this.controller=new g(e,t),this.registerView(o,r=>new l(r,this.controller)),this.addRibbonIcon("message-square","Toggle AI Helper Chat",async()=>{await this.toggleChat()}),this.addCommand({id:"toggle-ai-helper-chat",name:"Toggle AI Helper Chat",callback:async()=>{await this.toggleChat()}})}onunload(){this.app.workspace.detachLeavesOfType(o)}async toggleChat(){let e=this.app.workspace.getLeavesOfType(o);if(e.length>0){e.forEach(r=>r.detach());return}let t=this.app.workspace.getRightLeaf(!1);if(!t){new u.Notice("Could not open AI Helper panel.");return}await t.setViewState({type:o,active:!0}),this.app.workspace.revealLeaf(t)}};
