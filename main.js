"use strict";var F=Object.defineProperty;var ne=Object.getOwnPropertyDescriptor;var se=Object.getOwnPropertyNames;var ie=Object.prototype.hasOwnProperty;var ae=(o,e)=>{for(var t in e)F(o,t,{get:e[t],enumerable:!0})},le=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of se(e))!ie.call(o,n)&&n!==t&&F(o,n,{get:()=>e[n],enumerable:!(r=ne(e,n))||r.enumerable});return o};var ce=o=>le(F({},"__esModule",{value:!0}),o);var ye={};ae(ye,{default:()=>R});module.exports=ce(ye);var _=require("obsidian");var h="obsidian-vault-wizard-chat-view";var O=class{constructor(){this.selectedContextSnapshot=null;this.listeners=new Set}setSelection(e,t,r,n){let s=e.trim();if(!s)return;let l=Math.max(1,Math.min(r,n)),i=Math.max(l,Math.max(r,n));this.selectedContextSnapshot={text:s,sourcePath:t,startLineNumber:l,endLineNumber:i,updatedAt:Date.now()},this.notifyListeners()}getSelection(){return this.selectedContextSnapshot}clear(){this.selectedContextSnapshot&&(this.selectedContextSnapshot=null,this.notifyListeners())}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notifyListeners(){for(let e of this.listeners)e()}},m=new O;var B=class{constructor(){this.messages=[],this.conversationId="",this.appendSystemMessage()}appendSystemMessage(){this.messages.push({role:"system",content:["You are Vault Wizard, an expert assistant for note-based work.","Your core goal is to help the user think, write, and make decisions using their notes as primary context.","","Expected inputs:","- <NOTE_CONTENT_START> ... <NOTE_CONTENT_END>: the content of the user's active note.","- <SELECTED_CONTEXT_START> ... <SELECTED_CONTEXT_END>: the content of the user's selected context within the active note.","- <USER_QUERY> ... <USER_QUERY_END>: the user's current question or request.","","Behavior rules:","- Infer the domain from the notes and respond like a domain expert in that field.","- If context is incomplete or ambiguous, ask focused clarifying questions before making strong claims.","- If something is not clear, ask for clarification instead of making assumptions.","- Discuss the validity of the notes, you'll usually work with imperfect notes and it's important to be aware of their limitations.","- Clearly distinguish facts from assumptions.","- Prefer concise, structured answers with actionable next steps.","- When useful, provide examples, checklists, or summaries.","- Use Markdown formatting for readability.","","Safety and quality:","- Do not invent details that are not supported by the note context or the user's message.","- If a request conflicts with available context, explain the conflict and propose the safest useful alternative.","","Notes","- If SELECTED_CONTEXT is provided, it is more relevant than the general NOTE_CONTENT. Always prioritize it when formulating your response.","- When providing copy-paste snippets, ensure they are wrapped in ```...```. This applies everytime you provide some content that could be pasted in the current notes."].join(`
`)})}clear(e){this.messages=[],this.conversationId=e,this.appendSystemMessage()}getMessages(){return this.messages}appendMessage(e){this.messages.push(e)}},v=new B;var W=class{constructor(){this.traces=[];this.conversationId=""}clear(e){this.traces=[],this.conversationId=e}appendTrace(e){this.traces.push(e)}getTraces(){return this.traces}getAggregateTokenUsage(){return this.traces.reduce((e,t)=>t.tokenUsage?{inputTokens:e.inputTokens+t.tokenUsage.inputTokens,outputTokens:e.outputTokens+t.tokenUsage.outputTokens,cachedInputTokens:e.cachedInputTokens+t.tokenUsage.cachedInputTokens}:e,{inputTokens:0,outputTokens:0,cachedInputTokens:0})}},w=new W;var x=class{constructor(e,t,r,n,s){this.noteService=e;this.llmController=t;this.modelSettingsRepository=r;this.selectedModelState=n;this.conversationIdFactory=s;this.listeners=new Set;this.configuredModels=[];this.activePanel="chat";this.streaming=!1;this.conversationId=this.conversationIdFactory.createConversationId(),v.clear(this.conversationId),w.clear(this.conversationId)}async initialize(){let e=await this.modelSettingsRepository.loadModels();this.configuredModels.splice(0,this.configuredModels.length,...e),e.length>0?this.selectedModelState.setSelectedModel(e[0]):this.selectedModelState.setSelectedModel(null),this.notify()}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}getConversationId(){return this.conversationId}resetChatAndStartNewConversation(){this.conversationId=this.conversationIdFactory.createConversationId(),v.clear(this.conversationId),w.clear(this.conversationId),this.streaming=!1,this.notify()}getConfiguredModels(){return this.configuredModels}getSelectedConfiguredModel(){return this.selectedModelState.getSelectedModel()}selectConfiguredModelById(e){let t=this.configuredModels.find(r=>r.id===e)??null;this.selectedModelState.setSelectedModel(t),this.notify()}getActivePanel(){return this.activePanel}isStreaming(){return this.streaming}getActiveNotePath(){return this.noteService.getActiveNotePath()}getDebugTurns(){return w.getTraces()}getAggregateTokenUsage(){return w.getAggregateTokenUsage()}async saveConfiguredModel(e){let t=e.modelName.trim();if(!t)return;let r={id:`${Date.now()}-${Math.random().toString(36).slice(2,8)}`,provider:e.provider,modelName:t,settings:e.settings,createdAt:Date.now()},n=[...this.configuredModels,r];await this.modelSettingsRepository.saveModels(n),this.configuredModels.splice(0,this.configuredModels.length,...n),this.selectedModelState.getSelectedModel()||this.selectedModelState.setSelectedModel(r),this.notify()}openChatPanel(){this.setActivePanel("chat")}openDebugPanel(){this.setActivePanel("debug")}openSettingsPanel(){this.setActivePanel("settings")}openAddModelPanel(){this.setActivePanel("add-model")}returnToSettingsPanel(){this.setActivePanel("settings")}async onUserMessage(e){let t=e.trim(),r=await this.noteService.getContext();if(!t||this.streaming)return;if(v.appendMessage({role:"user",content:t,timestamp:Date.now()}),t==="/c"){v.appendMessage({role:"tool",content:r,timestamp:Date.now()}),this.notify();return}let n={role:"tool",content:r,timestamp:Date.now()};v.appendMessage(n);let s={role:"assistant",content:"",timestamp:Date.now()};v.appendMessage(s),m.clear(),this.streaming=!0,this.notify();let l=null;try{l=(await this.llmController.streamAssistantReply(t,c=>{s.content+=c,this.notify()})).tokenUsage??null}catch(i){let c=i instanceof Error?i.message:"Unexpected LLM error.";s.content+=`
${c}`}finally{w.appendTrace({timestamp:Date.now(),userPrompt:t,context:r,assistantResponse:s.content,tokenUsage:l}),this.streaming=!1,this.notify()}}setActivePanel(e){this.activePanel!==e&&(this.activePanel=e,this.notify())}notify(){for(let e of this.listeners)e()}};var C=class{constructor(e){this.app=e;this.settingsFilePath=".obsidian/plugins/vault_wizard/.model_settings.json";this.pluginFolderPath=".obsidian/plugins/vault_wizard"}async loadModels(){let e=this.app.vault.adapter;try{let t=await e.read(this.settingsFilePath),r=JSON.parse(t);return Array.isArray(r.models)?r.models:[]}catch{return[]}}async saveModels(e){let t=this.app.vault.adapter;await this.ensurePluginFolder(t);let r={models:[...e]};await t.write(this.settingsFilePath,JSON.stringify(r,null,2))}async ensurePluginFolder(e){try{await e.mkdir(this.pluginFolderPath)}catch{}}};var K=require("obsidian");var S=class{constructor(e){this.app=e;this.contextRequired=!0}async getActiveNoteContent(){let e=this.app.workspace.getActiveFile();return e?this.app.vault.cachedRead(e):"No active note is open."}notifyFileOpened(e){this.contextRequired=!0;let t=m.getSelection();t&&t.sourcePath!==e&&m.clear()}notifyFileModified(e){this.contextRequired=!0}captureSelectionFromActiveNote(){let e=this.app.workspace.getActiveFile();if(!e)return;let t=this.tryGetEditorSelectionSnapshot();if(t){m.setSelection(t.selectedText,e.path,t.startLineNumber,t.endLineNumber),this.contextRequired=!0;return}this.isEditorFocused()&&(m.clear(),this.contextRequired=!0)}async getContext(){let e="";if(this.contextRequired){let r=await this.getActiveNoteContent();e+=`<NOTE_CONTENT_START>
${r}
<NOTE_CONTENT_END>`,this.contextRequired=!1}let t=m.getSelection();return t?.text&&(e+=`
<SELECTED_CONTEXT_START>
${t.text}
<SELECTED_CONTEXT_END>`),console.log("Context retrieved:",e),e}getActiveNotePath(){return this.app.workspace.getActiveFile()?.path??"(none)"}tryGetEditorSelectionSnapshot(){let e=this.app.workspace.getActiveViewOfType(K.MarkdownView);if(!e?.editor)return null;let t=e.editor.getSelection();if(!t?.trim())return null;let r=e.editor.getCursor("from"),n=e.editor.getCursor("to"),s=Math.min(r.line,n.line)+1,l=Math.max(r.line,n.line)+1;return{selectedText:t,startLineNumber:s,endLineNumber:l}}isEditorFocused(){let e=document.activeElement;return e?e.closest(".cm-editor")!==null:!1}};var $=class{constructor(){this.listeners=new Set;this.selectedConfiguredModel=null}getSelectedModel(){return this.selectedConfiguredModel}setSelectedModel(e){this.selectedConfiguredModel=e,this.notifyListeners()}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notifyListeners(){for(let e of this.listeners)e()}},q=new $;var oe=require("obsidian");var E=require("obsidian");var de={azure:[{settingKey:"endpoint",label:"Endpoint",placeholder:"https://your-resource.openai.azure.com"},{settingKey:"apiKey",label:"API Key",placeholder:"Azure API key"},{settingKey:"deploymentName",label:"Deployment Name",placeholder:"e.g. gpt-4o-mini"},{settingKey:"apiVersion",label:"API Version",placeholder:"e.g. 2024-10-21"}],openai:[{settingKey:"apiKey",label:"API Key",placeholder:"OpenAI API key"},{settingKey:"model",label:"Model",placeholder:"e.g. gpt-4.1-mini"},{settingKey:"baseUrl",label:"Base URL (optional)",placeholder:"https://api.openai.com/v1"}],anthropic:[{settingKey:"apiKey",label:"API Key",placeholder:"Anthropic API key"},{settingKey:"model",label:"Model",placeholder:"e.g. claude-3-5-sonnet-latest"}]};function ue(o,e){let t=o.createDiv({cls:"vault-wizard-form-field"});t.createEl("label",{cls:"vault-wizard-form-label",text:e.label}),t.createEl("input",{cls:"vault-wizard-form-input",attr:{type:"text",placeholder:e.placeholder,"data-setting-key":e.settingKey}})}function G(o,e){o.empty();let t=de[e];for(let r of t)ue(o,r)}function pe(o){let e={},t=o.querySelectorAll("input[data-setting-key]");for(let r of t){let n=r.dataset.settingKey;n&&(e[n]=r.value.trim())}return e}function X(o,e){let t=o.createDiv({cls:"vault-wizard-settings-wrap"}),r=t.createDiv({cls:"vault-wizard-header"});r.createEl("h3",{text:"Add a model",cls:"vault-wizard-title"}),r.createEl("button",{cls:"vault-wizard-icon-btn vault-wizard-ghost-btn",text:"Back"}).addEventListener("click",()=>e.returnToSettingsPanel()),t.createEl("p",{cls:"vault-wizard-add-model-description",text:"Choose your AI provider to reveal the required connection fields."});let s=t.createDiv({cls:"vault-wizard-form vault-wizard-form-card"}),l=s.createDiv({cls:"vault-wizard-form-field"});l.createEl("label",{cls:"vault-wizard-form-label",text:"Model Name"});let i=l.createEl("input",{cls:"vault-wizard-form-input",attr:{type:"text",placeholder:"e.g. Main OpenAI Model"}}),c=s.createDiv({cls:"vault-wizard-form-field"});c.createEl("label",{cls:"vault-wizard-form-label",text:"AI Provider"});let a=c.createEl("select",{cls:"vault-wizard-form-select vault-wizard-provider-select"});a.createEl("option",{value:"",text:"Select provider..."}),a.createEl("option",{value:"azure",text:"Azure"}),a.createEl("option",{value:"openai",text:"OpenAI"}),a.createEl("option",{value:"anthropic",text:"Anthropic"});let u=s.createDiv({cls:"vault-wizard-form-provider-fields vault-wizard-provider-fields-card"});a.addEventListener("change",()=>{let p=a.value;if(!p){u.empty();return}G(u,p)}),s.createDiv({cls:"vault-wizard-add-model-actions"}).createEl("button",{cls:"vault-wizard-send-btn vault-wizard-add-model-save-btn",text:"Save"}).addEventListener("click",async()=>{let p=a.value,f=i.value.trim();if(!f){new E.Notice("Please enter a model name.");return}if(!p){new E.Notice("Please select an AI provider.");return}let b=pe(u);await e.saveConfiguredModel({provider:p,modelName:f,settings:b}),new E.Notice("Model saved."),e.returnToSettingsPanel()})}var ge=180,me=280;function Y(o,e){let t=o.createDiv({cls:"vault-wizard-debug-wrap"}),r=t.createDiv({cls:"vault-wizard-header"});r.createEl("h3",{text:"Debug",cls:"vault-wizard-title"}),r.createEl("button",{cls:"vault-wizard-icon-btn",text:"Back"}).addEventListener("click",()=>e.openChatPanel());let s=e.getAggregateTokenUsage(),l=t.createDiv({cls:"vault-wizard-debug-summary-card"});l.createEl("h4",{text:"Aggregate token usage",cls:"vault-wizard-debug-section-title"});let i=l.createDiv({cls:"vault-wizard-debug-usage-grid"});y(i,"Input",String(s.inputTokens)),y(i,"Output",String(s.outputTokens)),y(i,"Cached",String(s.cachedInputTokens));let c=e.getDebugTurns(),a=t.createDiv({cls:"vault-wizard-debug-traces-section"});if(a.createEl("h4",{text:`Requests (${c.length})`,cls:"vault-wizard-debug-section-title"}),c.length===0){a.createDiv({cls:"vault-wizard-debug-empty-state",text:"No debug traces yet."});return}let u=a.createDiv({cls:"vault-wizard-debug-traces-list"}),g=[...c].reverse();for(let d of g){let p=u.createDiv({cls:"vault-wizard-debug-trace-card"}),f=ve(d.userPrompt,d.context),b=j(d.assistantResponse,me),H=p.createDiv({cls:"vault-wizard-debug-block"});H.createEl("div",{text:"Request",cls:"vault-wizard-debug-block-title"}),H.createEl("pre",{text:f,cls:"vault-wizard-debug-code-block"});let V=p.createDiv({cls:"vault-wizard-debug-block"});V.createEl("div",{text:"Response",cls:"vault-wizard-debug-block-title"}),V.createEl("pre",{text:b,cls:"vault-wizard-debug-code-block"});let U=p.createDiv({cls:"vault-wizard-debug-usage-grid"});y(U,"Input",d.tokenUsage?String(d.tokenUsage.inputTokens):"n/a"),y(U,"Output",d.tokenUsage?String(d.tokenUsage.outputTokens):"n/a"),y(U,"Cached",d.tokenUsage?String(d.tokenUsage.cachedInputTokens):"n/a"),p.createEl("small",{cls:"vault-wizard-debug-timestamp",text:new Date(d.timestamp).toLocaleTimeString()})}}function ve(o,e){let t=e?.trim()?e.trim():"(no context sent)",r=`prompt="${o}"
context="${t}"`;return j(r,ge)}function j(o,e){return o.length<=e?o:`${o.slice(0,e)}\u2026`}function y(o,e,t){let r=o.createDiv({cls:"vault-wizard-debug-usage-item"});r.createEl("span",{text:e,cls:"vault-wizard-debug-usage-label"}),r.createEl("strong",{text:t,cls:"vault-wizard-debug-usage-value"})}function J(o,e){let t=o.createDiv({cls:"vault-wizard-settings-wrap"}),r=t.createDiv({cls:"vault-wizard-header"});r.createEl("h3",{text:"Settings",cls:"vault-wizard-title"}),r.createEl("button",{cls:"vault-wizard-icon-btn vault-wizard-ghost-btn",text:"Back"}).addEventListener("click",()=>e.openChatPanel()),t.createEl("p",{cls:"vault-wizard-settings-description",text:"Manage model connections used by the assistant."});let s=t.createDiv({cls:"vault-wizard-settings-card vault-wizard-form-card"});s.createEl("h4",{cls:"vault-wizard-settings-subtitle",text:"Available models"});let l=s.createDiv({cls:"vault-wizard-settings-list"}),i=e.getConfiguredModels();if(i.length===0)l.createDiv({cls:"vault-wizard-settings-empty",text:"No models configured yet."});else for(let u of i){let g=l.createDiv({cls:"vault-wizard-settings-row"});g.createSpan({cls:"vault-wizard-settings-provider-badge",text:u.provider}),g.createSpan({cls:"vault-wizard-settings-model-name",text:u.modelName})}t.createDiv({cls:"vault-wizard-settings-actions"}).createEl("button",{cls:"vault-wizard-send-btn vault-wizard-settings-primary-action",text:"Add a model"}).addEventListener("click",()=>e.openAddModelPanel())}function Q(o,e,t,r){let n=o.createDiv({cls:"vault-wizard-composer"}),s=n.createEl("textarea",{cls:"vault-wizard-input",attr:{placeholder:"Type message (/c for current note content)..."}}),l=n.createEl("button",{cls:"vault-wizard-send-btn",text:t?"...":"Send"});l.disabled=t;let i=()=>{r?.()},c=async()=>{let a=s.value;s.value="",await e(a)};n.addEventListener("mousedown",i),s.addEventListener("focus",i),l.addEventListener("click",c),s.addEventListener("keydown",async a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),await c())})}var M=require("obsidian");function Z(o,e,t,r,n,s,l){let i=o.createDiv({cls:"vault-wizard-header"});i.createEl("h3",{text:"Vault Wizard",cls:"vault-wizard-title"});let c=i.createDiv({cls:"vault-wizard-header-actions"}),a=c.createEl("select",{cls:"vault-wizard-form-select vault-wizard-header-model-select"});if(r.length===0){let p=a.createEl("option",{value:"",text:"No models"});p.selected=!0,a.disabled=!0}else{for(let p of r){let f=`${p.provider} \u2022 ${p.modelName}`,b=a.createEl("option",{value:p.id,text:f});n&&p.id===n&&(b.selected=!0)}a.addEventListener("change",()=>{a.value&&s(a.value)})}let u=c.createEl("button",{cls:"vault-wizard-icon-btn vault-wizard-new-chat-btn"});u.setAttribute("aria-label","Start new chat"),(0,M.setIcon)(u,"plus"),u.addEventListener("click",l);let g=c.createEl("button",{cls:"vault-wizard-icon-btn"});g.setAttribute("aria-label","Open debug panel"),(0,M.setIcon)(g,"bug"),g.addEventListener("click",e);let d=c.createEl("button",{cls:"vault-wizard-icon-btn"});d.setAttribute("aria-label","Open settings panel"),(0,M.setIcon)(d,"settings"),d.addEventListener("click",t)}var ee=require("obsidian"),k=class{constructor(e){this.renderingContext=e}renderMarkdown(e,t){e.empty(),ee.MarkdownRenderer.render(this.renderingContext.app,t,e,this.renderingContext.sourcePath,this.renderingContext.component)}};function he(o){return o.role==="user"?"You":"Assistant"}function fe(o){return o.timestamp?new Date(o.timestamp).toLocaleTimeString():""}function te(o,e,t){let r=o.createDiv({cls:"vault-wizard-message-list"}),n=new k({app:t.app,component:t.component,sourcePath:t.sourcePath});for(let s of e){if(s.role==="system"||s.role==="tool")continue;let i=r.createDiv({cls:`vault-wizard-message-row vault-wizard-message-row-${s.role}`}).createDiv({cls:`vault-wizard-message vault-wizard-${s.role}`}),c=i.createDiv({cls:"vault-wizard-message-meta"});c.createSpan({cls:"vault-wizard-message-role",text:he(s)});let a=fe(s);a&&c.createSpan({cls:"vault-wizard-message-time",text:a});let u=i.createDiv({cls:"vault-wizard-message-content markdown-rendered"});n.renderMarkdown(u,s.content)}r.scrollTop=r.scrollHeight}function re(o,e){if(!e)return;let t=o.createDiv({cls:"vault-wizard-selected-context-badge"});t.createSpan({cls:"vault-wizard-selected-context-file",text:e.sourcePath}),t.createSpan({cls:"vault-wizard-selected-context-lines",text:we(e.startLineNumber,e.endLineNumber)})}function we(o,e){return o===e?`Line ${o}`:`Lines ${o}\u2013${e}`}var T=class extends oe.ItemView{constructor(t,r){super(t);this.controller=r;this.isOpen=!1}getViewType(){return h}getOpenStatus(){return this.isOpen}setOpenStatus(t){this.isOpen=t}getDisplayText(){return"Vault Wizard Chat"}getIcon(){return"bot"}async onOpen(){this.unsubscribe=this.controller.subscribe(()=>this.render()),this.unsubscribeSelection=m.subscribe(()=>this.render()),this.render()}async onClose(){this.unsubscribe?.(),this.unsubscribeSelection?.()}render(){let{contentEl:t}=this;t.empty(),t.addClass("vault-wizard-root");let r=this.controller.getActivePanel();if(r==="debug"){Y(t,this.controller);return}if(r==="settings"){J(t,this.controller);return}if(r==="add-model"){X(t,this.controller);return}let n=this.controller.getSelectedConfiguredModel();Z(t,()=>this.controller.openDebugPanel(),()=>this.controller.openSettingsPanel(),this.controller.getConfiguredModels(),n?.id??null,s=>this.controller.selectConfiguredModelById(s),()=>this.controller.resetChatAndStartNewConversation()),te(t,v.getMessages(),{app:this.app,component:this,sourcePath:this.controller.getActiveNotePath()}),re(t,m.getSelection()),Q(t,async s=>{await this.controller.onUserMessage(s)},this.controller.isStreaming())}};var z=class{constructor(e,t){this.selectedModelState=e;this.aiInvokerFactory=t}async streamAssistantReply(e,t){let r=this.selectedModelState.getSelectedModel();return r?await this.aiInvokerFactory.getInvoker(r.provider).streamResponse({newUserMessage:e,configuredModel:r},t):(t("No model selected. Please configure and select a model."),{})}};var P=class{constructor(e){this.azureAIInvoker=e}getInvoker(e){if(e==="azure")return this.azureAIInvoker;throw new Error(`No AI invoker implemented yet for provider: ${e}`)}};var A=class{constructor(e){this.textExtractor=e}async consume(e,t,r){let n=e.body;if(!n)return;let s=n.getReader(),l=new TextDecoder("utf-8"),i="";for(;;){let{value:a,done:u}=await s.read();if(u)break;i+=l.decode(a,{stream:!0});let g=i.split(`

`);i=g.pop()??"";for(let d of g)this.processEventBlock(d,t,r)}let c=i.trim();c&&this.processEventBlock(c,t,r)}processEventBlock(e,t,r){let n=e.split(`
`);for(let s of n){let l=s.trim();if(!l.startsWith("data:"))continue;let i=l.slice(5).trim();if(!(!i||i==="[DONE]"))try{let c=JSON.parse(i);r?.(c);let a=this.textExtractor.extractDelta(c);a&&t(a)}catch{}}}};var I=class{extractDelta(e){let t=e;return t?.delta??t?.choices?.[0]?.delta?.content??t?.output_text?.delta??t?.response?.output_text?.delta??""}extractText(e){let t=e;if(typeof t?.output_text=="string")return t.output_text;if(typeof t?.choices?.[0]?.message?.content=="string")return t.choices[0].message.content;let r=t?.output?.[0]?.content;return Array.isArray(r)?r.map(n=>n?.text??"").filter(Boolean).join(""):""}};var N=class{extract(e){let t=e,r=t?.usage??t?.response?.usage??t?.data?.usage??null;if(!r||typeof r!="object")return null;let n=this.toNonNegativeNumber(r.input_tokens??r.prompt_tokens??r.inputTokens),s=this.toNonNegativeNumber(r.output_tokens??r.completion_tokens??r.outputTokens),l=this.toNonNegativeNumber(r.cached_input_tokens??r.cached_tokens??r?.input_tokens_details?.cached_tokens??r?.prompt_tokens_details?.cached_tokens);return n===null&&s===null&&l===null?null:{inputTokens:n??0,outputTokens:s??0,cachedInputTokens:l??0}}toNonNegativeNumber(e){return typeof e!="number"||!Number.isFinite(e)||e<0?null:e}};var L=class{constructor(){this.textExtractor=new I;this.usageExtractor=new N;this.sseReader=new A(this.textExtractor)}async streamResponse(e,t){let r=this.tryGetSetting(e,"endpoint"),n=this.tryGetSetting(e,"apiKey"),s=this.tryGetSetting(e,"deploymentName"),l=this.tryGetSetting(e,"apiVersion"),i=this.buildResponsesUrl(r,l);console.log(e);let c={model:s,input:this.buildInputMessages(),max_output_tokens:2048,stream:!0},a=await fetch(i,{method:"POST",headers:this.buildHeaders(n),body:JSON.stringify(c)});if(!a.ok){let g=await a.text();throw new Error(`Azure REST error ${a.status}: ${g}`)}let u;if(!a.body){let g=await a.json(),d=this.textExtractor.extractText(g);d&&t(d);let p=this.usageExtractor.extract(g);return p&&(u=p),{tokenUsage:u}}return await this.sseReader.consume(a,t,g=>{let d=this.usageExtractor.extract(g);d&&(u=d)}),{tokenUsage:u}}buildHeaders(e){return{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}tryGetSetting(e,t){let r=e.configuredModel.settings[t];if(!r)throw new Error(`Missing required setting: ${t}`);return r}buildResponsesUrl(e,t){return`${e.replace(/\/+$/,"")}/openai/responses?api-version=${encodeURIComponent(t)}`}buildInputMessages(){return v.getMessages().map(t=>{let r=t.role,n=t.content;return r=="tool"&&(r="user",n=`<CONTEXT>
${n}
</CONTEXT>`),{role:r,content:n}})}};var D=class{createConversationId(){let e=Date.now().toString(36),t=Math.random().toString(36).slice(2,10);return`conv_${e}_${t}`}};var R=class extends _.Plugin{async onload(){let e=new S(this.app),t=new C(this.app),r=new L,n=new P(r),s=new z(q,n),l=new D;this.controller=new x(e,s,t,q,l),await this.controller.initialize(),this.app.workspace.on("file-open",i=>{i&&e.notifyFileOpened(i.path)}),this.app.vault.on("modify",i=>{i&&e.notifyFileModified(i.path)}),this.registerDomEvent(document,"selectionchange",()=>{e.captureSelectionFromActiveNote()}),this.registerView(h,i=>new T(i,this.controller)),this.addRibbonIcon("message-square","Toggle Vault Wizard Chat",async()=>{await this.toggleChat()}),this.addCommand({id:"toggle-vault-wizard-chat",name:"Toggle Vault Wizard Chat",callback:async()=>{await this.toggleChat()}}),this.addCommand({id:"vault-wizard-new-chat",name:"Vault Wizard New Chat",callback:async()=>{await this.newChatCommand()}})}onunload(){this.app.workspace.detachLeavesOfType(h)}async toggleChat(){let e=this.app.workspace.getLeavesOfType(h);if(e.length>0){e.forEach(r=>r.detach());return}let t=this.app.workspace.getRightLeaf(!1);if(!t){new _.Notice("Could not open Vault Wizard panel.");return}await t.setViewState({type:h,active:!0}),this.app.workspace.revealLeaf(t)}async newChatCommand(){this.controller.resetChatAndStartNewConversation()}};
