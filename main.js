"use strict";var R=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var G=Object.getOwnPropertyNames;var J=Object.prototype.hasOwnProperty;var j=(i,e)=>{for(var t in e)R(i,t,{get:e[t],enumerable:!0})},q=(i,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of G(e))!J.call(i,o)&&o!==t&&R(i,o,{get:()=>e[o],enumerable:!(r=O(e,o))||r.enumerable});return i};var Y=i=>q(R({},"__esModule",{value:!0}),i);var ee={};j(ee,{default:()=>k});module.exports=Y(ee);var L=require("obsidian");var g="obsidian-vault-wizard-chat-view";var N=class{constructor(){this.messages=[],this.conversationId=""}clear(e){this.messages=[],this.conversationId=e}getMessages(){return this.messages}appendMessage(e){this.messages.push(e)}},u=new N;var f=class{constructor(e,t,r,o,n){this.noteService=e;this.llmController=t;this.modelSettingsRepository=r;this.selectedModelState=o;this.conversationIdFactory=n;this.listeners=new Set;this.configuredModels=[];this.activePanel="chat";this.streaming=!1;this.conversationId=this.conversationIdFactory.createConversationId(),u.clear(this.conversationId)}async initialize(){let e=await this.modelSettingsRepository.loadModels();this.configuredModels.splice(0,this.configuredModels.length,...e),e.length>0?this.selectedModelState.setSelectedModel(e[0]):this.selectedModelState.setSelectedModel(null),this.notify()}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}getConversationId(){return this.conversationId}resetChatAndStartNewConversation(){this.conversationId=this.conversationIdFactory.createConversationId(),u.clear(this.conversationId),this.notify()}getConfiguredModels(){return this.configuredModels}getSelectedConfiguredModel(){return this.selectedModelState.getSelectedModel()}selectConfiguredModelById(e){let t=this.configuredModels.find(r=>r.id===e)??null;this.selectedModelState.setSelectedModel(t),this.notify()}getActivePanel(){return this.activePanel}isStreaming(){return this.streaming}getActiveNotePath(){return this.noteService.getActiveNotePath()}async saveConfiguredModel(e){let t=e.modelName.trim();if(!t)return;let r={id:`${Date.now()}-${Math.random().toString(36).slice(2,8)}`,provider:e.provider,modelName:t,settings:e.settings,createdAt:Date.now()},o=[...this.configuredModels,r];await this.modelSettingsRepository.saveModels(o),this.configuredModels.splice(0,this.configuredModels.length,...o),this.selectedModelState.getSelectedModel()||this.selectedModelState.setSelectedModel(r),this.notify()}openChatPanel(){this.setActivePanel("chat")}openDebugPanel(){this.setActivePanel("debug")}openSettingsPanel(){this.setActivePanel("settings")}openAddModelPanel(){this.setActivePanel("add-model")}returnToSettingsPanel(){this.setActivePanel("settings")}async onUserMessage(e){let t=e.trim();if(!t||this.streaming)return;if(t==="/c"){let o=await this.noteService.getActiveNoteContent();u.appendMessage({role:"assistant",content:o,timestamp:Date.now()}),this.notify();return}u.appendMessage({role:"user",content:t,timestamp:Date.now()});let r={role:"assistant",content:"",timestamp:Date.now()};u.appendMessage(r),this.streaming=!0,this.notify();try{let o=await this.noteService.getContext();await this.llmController.streamAssistantReply(t,o,n=>{r.content+=n,this.notify()})}catch(o){let n=o instanceof Error?o.message:"Unexpected LLM error.";r.content+=`
${n}`}finally{this.streaming=!1,this.notify()}}setActivePanel(e){this.activePanel!==e&&(this.activePanel=e,this.notify())}notify(){for(let e of this.listeners)e()}};var y=class{constructor(e){this.app=e;this.settingsFilePath=".obsidian/plugins/vault_wizard/.model_settings.json";this.pluginFolderPath=".obsidian/plugins/vault_wizard"}async loadModels(){let e=this.app.vault.adapter;try{let t=await e.read(this.settingsFilePath),r=JSON.parse(t);return Array.isArray(r.models)?r.models:[]}catch{return[]}}async saveModels(e){let t=this.app.vault.adapter;await this.ensurePluginFolder(t);let r={models:[...e]};await t.write(this.settingsFilePath,JSON.stringify(r,null,2))}async ensurePluginFolder(e){try{await e.mkdir(this.pluginFolderPath)}catch{}}};var w=class{constructor(e){this.app=e}async getActiveNoteContent(){let e=this.app.workspace.getActiveFile();return e?this.app.vault.cachedRead(e):"No active note is open."}async getContext(){return"todo"}getActiveNotePath(){return this.app.workspace.getActiveFile()?.path??"(none)"}};var T=class{constructor(){this.listeners=new Set;this.selectedConfiguredModel=null}getSelectedModel(){return this.selectedConfiguredModel}setSelectedModel(e){this.selectedConfiguredModel=e,this.notifyListeners()}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notifyListeners(){for(let e of this.listeners)e()}},B=new T;var $=require("obsidian");var M=require("obsidian");var Q={azure:[{settingKey:"endpoint",label:"Endpoint",placeholder:"https://your-resource.openai.azure.com"},{settingKey:"apiKey",label:"API Key",placeholder:"Azure API key"},{settingKey:"deploymentName",label:"Deployment Name",placeholder:"e.g. gpt-4o-mini"},{settingKey:"apiVersion",label:"API Version",placeholder:"e.g. 2024-10-21"}],openai:[{settingKey:"apiKey",label:"API Key",placeholder:"OpenAI API key"},{settingKey:"model",label:"Model",placeholder:"e.g. gpt-4.1-mini"},{settingKey:"baseUrl",label:"Base URL (optional)",placeholder:"https://api.openai.com/v1"}],anthropic:[{settingKey:"apiKey",label:"API Key",placeholder:"Anthropic API key"},{settingKey:"model",label:"Model",placeholder:"e.g. claude-3-5-sonnet-latest"}]};function X(i,e){let t=i.createDiv({cls:"vault-wizard-form-field"});t.createEl("label",{cls:"vault-wizard-form-label",text:e.label}),t.createEl("input",{cls:"vault-wizard-form-input",attr:{type:"text",placeholder:e.placeholder,"data-setting-key":e.settingKey}})}function F(i,e){i.empty();let t=Q[e];for(let r of t)X(i,r)}function Z(i){let e={},t=i.querySelectorAll("input[data-setting-key]");for(let r of t){let o=r.dataset.settingKey;o&&(e[o]=r.value.trim())}return e}function K(i,e){let t=i.createDiv({cls:"vault-wizard-settings-wrap"}),r=t.createDiv({cls:"vault-wizard-header"});r.createEl("h3",{text:"Add a model",cls:"vault-wizard-title"}),r.createEl("button",{cls:"vault-wizard-icon-btn vault-wizard-ghost-btn",text:"Back"}).addEventListener("click",()=>e.returnToSettingsPanel()),t.createEl("p",{cls:"vault-wizard-add-model-description",text:"Choose your AI provider to reveal the required connection fields."});let n=t.createDiv({cls:"vault-wizard-form vault-wizard-form-card"}),a=n.createDiv({cls:"vault-wizard-form-field"});a.createEl("label",{cls:"vault-wizard-form-label",text:"Model Name"});let l=a.createEl("input",{cls:"vault-wizard-form-input",attr:{type:"text",placeholder:"e.g. Main OpenAI Model"}}),c=n.createDiv({cls:"vault-wizard-form-field"});c.createEl("label",{cls:"vault-wizard-form-label",text:"AI Provider"});let s=c.createEl("select",{cls:"vault-wizard-form-select vault-wizard-provider-select"});s.createEl("option",{value:"",text:"Select provider..."}),s.createEl("option",{value:"azure",text:"Azure"}),s.createEl("option",{value:"openai",text:"OpenAI"}),s.createEl("option",{value:"anthropic",text:"Anthropic"});let d=n.createDiv({cls:"vault-wizard-form-provider-fields vault-wizard-provider-fields-card"});s.addEventListener("change",()=>{let p=s.value;if(!p){d.empty();return}F(d,p)}),n.createDiv({cls:"vault-wizard-add-model-actions"}).createEl("button",{cls:"vault-wizard-send-btn vault-wizard-add-model-save-btn",text:"Save"}).addEventListener("click",async()=>{let p=s.value,h=l.value.trim();if(!h){new M.Notice("Please enter a model name.");return}if(!p){new M.Notice("Please select an AI provider.");return}let D=Z(d);await e.saveConfiguredModel({provider:p,modelName:h,settings:D}),new M.Notice("Model saved."),e.returnToSettingsPanel()})}function W(i,e){let t=i.createDiv({cls:"vault-wizard-debug-wrap"}),r=t.createDiv({cls:"vault-wizard-header"});r.createEl("h3",{text:"Debug",cls:"vault-wizard-title"}),r.createEl("button",{cls:"vault-wizard-icon-btn",text:"Back"}).addEventListener("click",()=>e.openChatPanel());let n=t.createEl("pre",{cls:"vault-wizard-debug-pre"}),a={messageCount:u.getMessages().length,streaming:e.isStreaming(),activeNotePath:e.getActiveNotePath(),configuredModels:e.getConfiguredModels().length};n.textContent=JSON.stringify(a,null,2)}function H(i,e){let t=i.createDiv({cls:"vault-wizard-settings-wrap"}),r=t.createDiv({cls:"vault-wizard-header"});r.createEl("h3",{text:"Settings",cls:"vault-wizard-title"}),r.createEl("button",{cls:"vault-wizard-icon-btn vault-wizard-ghost-btn",text:"Back"}).addEventListener("click",()=>e.openChatPanel()),t.createEl("p",{cls:"vault-wizard-settings-description",text:"Manage model connections used by the assistant."});let n=t.createDiv({cls:"vault-wizard-settings-card vault-wizard-form-card"});n.createEl("h4",{cls:"vault-wizard-settings-subtitle",text:"Available models"});let a=n.createDiv({cls:"vault-wizard-settings-list"}),l=e.getConfiguredModels();if(l.length===0)a.createDiv({cls:"vault-wizard-settings-empty",text:"No models configured yet."});else for(let d of l){let v=a.createDiv({cls:"vault-wizard-settings-row"});v.createSpan({cls:"vault-wizard-settings-provider-badge",text:d.provider}),v.createSpan({cls:"vault-wizard-settings-model-name",text:d.modelName})}t.createDiv({cls:"vault-wizard-settings-actions"}).createEl("button",{cls:"vault-wizard-send-btn vault-wizard-settings-primary-action",text:"Add a model"}).addEventListener("click",()=>e.openAddModelPanel())}function _(i,e,t){let r=i.createDiv({cls:"vault-wizard-composer"}),o=r.createEl("textarea",{cls:"vault-wizard-input",attr:{placeholder:"Type message (/c for current note content)..."}}),n=r.createEl("button",{cls:"vault-wizard-send-btn",text:t?"...":"Send"});n.disabled=t;let a=async()=>{let l=o.value;o.value="",await e(l)};n.addEventListener("click",a),o.addEventListener("keydown",async l=>{l.key==="Enter"&&!l.shiftKey&&(l.preventDefault(),await a())})}var C=require("obsidian");function V(i,e,t,r,o,n,a){let l=i.createDiv({cls:"vault-wizard-header"});l.createEl("h3",{text:"Vault Wizard",cls:"vault-wizard-title"});let c=l.createDiv({cls:"vault-wizard-header-actions"}),s=c.createEl("select",{cls:"vault-wizard-form-select vault-wizard-header-model-select"});if(r.length===0){let p=s.createEl("option",{value:"",text:"No models"});p.selected=!0,s.disabled=!0}else{for(let p of r){let h=`${p.provider} \u2022 ${p.modelName}`,D=s.createEl("option",{value:p.id,text:h});o&&p.id===o&&(D.selected=!0)}s.addEventListener("change",()=>{s.value&&n(s.value)})}let d=c.createEl("button",{cls:"vault-wizard-icon-btn vault-wizard-new-chat-btn"});d.setAttribute("aria-label","Start new chat"),(0,C.setIcon)(d,"plus"),d.addEventListener("click",a);let v=c.createEl("button",{cls:"vault-wizard-icon-btn"});v.setAttribute("aria-label","Open debug panel"),(0,C.setIcon)(v,"bug"),v.addEventListener("click",e);let m=c.createEl("button",{cls:"vault-wizard-icon-btn"});m.setAttribute("aria-label","Open settings panel"),(0,C.setIcon)(m,"settings"),m.addEventListener("click",t)}function U(i,e){let t=i.createDiv({cls:"vault-wizard-message-list"});for(let r of e)t.createDiv({cls:`vault-wizard-message vault-wizard-${r.role}`}).createDiv({cls:"vault-wizard-message-content",text:r.content});t.scrollTop=t.scrollHeight}var b=class extends $.ItemView{constructor(t,r){super(t);this.controller=r}getViewType(){return g}getDisplayText(){return"Vault Wizard Chat"}getIcon(){return"bot"}async onOpen(){this.unsubscribe=this.controller.subscribe(()=>this.render()),this.render()}async onClose(){this.unsubscribe?.()}render(){let{contentEl:t}=this;t.empty(),t.addClass("vault-wizard-root");let r=this.controller.getActivePanel();if(r==="debug"){W(t,this.controller);return}if(r==="settings"){H(t,this.controller);return}if(r==="add-model"){K(t,this.controller);return}let o=this.controller.getSelectedConfiguredModel();V(t,()=>this.controller.openDebugPanel(),()=>this.controller.openSettingsPanel(),this.controller.getConfiguredModels(),o?.id??null,n=>this.controller.selectConfiguredModelById(n),()=>this.controller.resetChatAndStartNewConversation()),U(t,u.getMessages()),_(t,async n=>this.controller.onUserMessage(n),this.controller.isStreaming())}};var S=class{constructor(e,t){this.selectedModelState=e;this.aiInvokerFactory=t}async streamAssistantReply(e,t,r){let o=this.selectedModelState.getSelectedModel();if(!o){r("No model selected. Please configure and select a model.");return}await this.aiInvokerFactory.getInvoker(o.provider).streamResponse({newUserMessage:e,context:t,configuredModel:o},r)}};var P=class{constructor(e){this.azureAIInvoker=e}getInvoker(e){if(e==="azure")return this.azureAIInvoker;throw new Error(`No AI invoker implemented yet for provider: ${e}`)}};var x=class{build(e){let r=u.getMessages().map(n=>this.toInputItem(n)).filter(n=>n!==null),o=this.tryGetUserMessage(e);return o&&r.push({role:"user",content:o}),r}toInputItem(e){let t=e.role,r=e.content;return typeof t!="string"||typeof r!="string"||!r.trim()||t!=="system"&&t!=="user"&&t!=="assistant"?null:{role:t,content:r}}tryGetUserMessage(e){let t=e,r=["userMessage","prompt","message"];for(let o of r){let n=t[o];if(typeof n=="string"&&n.trim())return n}return""}};var I=class{constructor(e){this.textExtractor=e}async consume(e,t){let r=e.body;if(!r)return;let o=r.getReader(),n=new TextDecoder("utf-8"),a="";for(;;){let{value:l,done:c}=await o.read();if(c)break;a+=n.decode(l,{stream:!0});let s=a.split(`

`);a=s.pop()??"";for(let d of s)this.processEventBlock(d,t)}}processEventBlock(e,t){let r=e.split(`
`);for(let o of r){let n=o.trim();if(!n.startsWith("data:"))continue;let a=n.slice(5).trim();if(!(!a||a==="[DONE]"))try{let l=JSON.parse(a),c=this.textExtractor.extractDelta(l);c&&t(c)}catch{}}}};var A=class{extractDelta(e){let t=e;return t?.delta??t?.choices?.[0]?.delta?.content??t?.output_text?.delta??t?.response?.output_text?.delta??""}extractText(e){let t=e;if(typeof t?.output_text=="string")return t.output_text;if(typeof t?.choices?.[0]?.message?.content=="string")return t.choices[0].message.content;let r=t?.output?.[0]?.content;return Array.isArray(r)?r.map(o=>o?.text??"").filter(Boolean).join(""):""}};var z=class{constructor(){this.inputBuilder=new x;this.textExtractor=new A;this.sseReader=new I(this.textExtractor)}async streamResponse(e,t){let r=this.tryGetSetting(e,"endpoint"),o=this.tryGetSetting(e,"apiKey"),n=this.tryGetSetting(e,"deploymentName"),a=this.tryGetSetting(e,"apiVersion"),l=this.buildResponsesUrl(r,a),c={model:n,input:this.inputBuilder.build(e),max_output_tokens:2048,stream:!0},s=await fetch(l,{method:"POST",headers:this.buildHeaders(o),body:JSON.stringify(c)});if(!s.ok){let d=await s.text();throw new Error(`Azure REST error ${s.status}: ${d}`)}if(!s.body){let d=await s.json(),v=this.textExtractor.extractText(d);v&&t(v);return}await this.sseReader.consume(s,t)}buildHeaders(e){return{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}tryGetSetting(e,t){let r=e.configuredModel.settings[t];if(!r)throw new Error(`Missing required setting: ${t}`);return r}buildResponsesUrl(e,t){return`${e.replace(/\/+$/,"")}/openai/responses?api-version=${encodeURIComponent(t)}`}};var E=class{createConversationId(){let e=Date.now().toString(36),t=Math.random().toString(36).slice(2,10);return`conv_${e}_${t}`}};var k=class extends L.Plugin{async onload(){let e=new w(this.app),t=new y(this.app),r=new z,o=new P(r),n=new S(B,o),a=new E;this.controller=new f(e,n,t,B,a),await this.controller.initialize(),this.registerView(g,l=>new b(l,this.controller)),this.addRibbonIcon("message-square","Toggle Vault Wizard Chat",async()=>{await this.toggleChat()}),this.addCommand({id:"toggle-vault-wizard-chat",name:"Toggle Vault Wizard Chat",callback:async()=>{await this.toggleChat()}})}onunload(){this.app.workspace.detachLeavesOfType(g)}async toggleChat(){let e=this.app.workspace.getLeavesOfType(g);if(e.length>0){e.forEach(r=>r.detach());return}let t=this.app.workspace.getRightLeaf(!1);if(!t){new L.Notice("Could not open Vault Wizard panel.");return}await t.setViewState({type:g,active:!0}),this.app.workspace.revealLeaf(t)}};
