"use strict";var C=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var H=(o,e)=>{for(var t in e)C(o,t,{get:e[t],enumerable:!0})},V=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of B(e))!R.call(o,i)&&i!==t&&C(o,i,{get:()=>e[i],enumerable:!(r=K(e,i))||r.enumerable});return o};var _=o=>V(C({},"__esModule",{value:!0}),o);var q={};H(q,{default:()=>y});module.exports=_(q);var P=require("obsidian");var v="obsidian-vault-wizard-chat-view";var g=class{constructor(e,t,r,i){this.noteService=e;this.chatService=t;this.modelSettingsRepository=r;this.selectedModelState=i;this.listeners=new Set;this.messages=[];this.configuredModels=[];this.activePanel="chat";this.streaming=!1}async initialize(){let e=await this.modelSettingsRepository.loadModels();this.configuredModels.splice(0,this.configuredModels.length,...e),e.length>0?this.selectedModelState.setSelectedModel(e[0]):this.selectedModelState.setSelectedModel(null),this.notify()}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}getMessages(){return this.messages}getConfiguredModels(){return this.configuredModels}getSelectedConfiguredModel(){return this.selectedModelState.getSelectedModel()}selectConfiguredModelById(e){let t=this.configuredModels.find(r=>r.id===e)??null;this.selectedModelState.setSelectedModel(t),this.notify()}getActivePanel(){return this.activePanel}isStreaming(){return this.streaming}getActiveNotePath(){return this.noteService.getActiveNotePath()}async saveConfiguredModel(e){let t=e.modelName.trim();if(!t)return;let r={id:`${Date.now()}-${Math.random().toString(36).slice(2,8)}`,provider:e.provider,modelName:t,settings:e.settings,createdAt:Date.now()},i=[...this.configuredModels,r];await this.modelSettingsRepository.saveModels(i),this.configuredModels.splice(0,this.configuredModels.length,...i),this.selectedModelState.getSelectedModel()||this.selectedModelState.setSelectedModel(r),this.notify()}openChatPanel(){this.setActivePanel("chat")}openDebugPanel(){this.setActivePanel("debug")}openSettingsPanel(){this.setActivePanel("settings")}openAddModelPanel(){this.setActivePanel("add-model")}returnToSettingsPanel(){this.setActivePanel("settings")}async onUserMessage(e){let t=e.trim();if(!t||this.streaming)return;if(t==="/c"){let i=await this.noteService.getActiveNoteContent();this.messages.push({role:"assistant",content:i,timestamp:Date.now()}),this.notify();return}this.messages.push({role:"user",content:t,timestamp:Date.now()});let r={role:"assistant",content:"",timestamp:Date.now()};this.messages.push(r),this.streaming=!0,this.notify(),await this.chatService.streamEcho(t,i=>{r.content+=i,this.notify()}),this.streaming=!1,this.notify()}setActivePanel(e){this.activePanel!==e&&(this.activePanel=e,this.notify())}notify(){for(let e of this.listeners)e()}};var m=class{async streamEcho(e,t){let r=`echo: ${e}`;for(let i=0;i<r.length;i+=3)t(r.slice(i,i+3)),await this.sleep(35)}sleep(e){return new Promise(t=>window.setTimeout(t,e))}};var h=class{constructor(e){this.app=e;this.settingsFilePath=".obsidian/plugins/vault_wizard/.model_settings.json";this.pluginFolderPath=".obsidian/plugins/vault_wizard"}async loadModels(){let e=this.app.vault.adapter;try{let t=await e.read(this.settingsFilePath),r=JSON.parse(t);return Array.isArray(r.models)?r.models:[]}catch{return[]}}async saveModels(e){let t=this.app.vault.adapter;await this.ensurePluginFolder(t);let r={models:[...e]};await t.write(this.settingsFilePath,JSON.stringify(r,null,2))}async ensurePluginFolder(e){try{await e.mkdir(this.pluginFolderPath)}catch{}}};var f=class{constructor(e){this.app=e}async getActiveNoteContent(){let e=this.app.workspace.getActiveFile();return e?this.app.vault.cachedRead(e):"No active note is open."}getActiveNotePath(){return this.app.workspace.getActiveFile()?.path??"(none)"}};var b=class{constructor(){this.listeners=new Set;this.selectedConfiguredModel=null}getSelectedModel(){return this.selectedConfiguredModel}setSelectedModel(e){this.selectedConfiguredModel=e,this.notifyListeners()}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notifyListeners(){for(let e of this.listeners)e()}},A=new b;var W=require("obsidian");var w=require("obsidian");var O={azure:[{settingKey:"endpoint",label:"Endpoint",placeholder:"https://your-resource.openai.azure.com"},{settingKey:"apiKey",label:"API Key",placeholder:"Azure API key"},{settingKey:"deploymentName",label:"Deployment Name",placeholder:"e.g. gpt-4o-mini"},{settingKey:"apiVersion",label:"API Version",placeholder:"e.g. 2024-10-21"}],openai:[{settingKey:"apiKey",label:"API Key",placeholder:"OpenAI API key"},{settingKey:"model",label:"Model",placeholder:"e.g. gpt-4.1-mini"},{settingKey:"baseUrl",label:"Base URL (optional)",placeholder:"https://api.openai.com/v1"}],anthropic:[{settingKey:"apiKey",label:"API Key",placeholder:"Anthropic API key"},{settingKey:"model",label:"Model",placeholder:"e.g. claude-3-5-sonnet-latest"}]};function U(o,e){let t=o.createDiv({cls:"vault-wizard-form-field"});t.createEl("label",{cls:"vault-wizard-form-label",text:e.label}),t.createEl("input",{cls:"vault-wizard-form-input",attr:{type:"text",placeholder:e.placeholder,"data-setting-key":e.settingKey}})}function x(o,e){o.empty();let t=O[e];for(let r of t)U(o,r)}function $(o){let e={},t=o.querySelectorAll("input[data-setting-key]");for(let r of t){let i=r.dataset.settingKey;i&&(e[i]=r.value.trim())}return e}function L(o,e){let t=o.createDiv({cls:"vault-wizard-settings-wrap"}),r=t.createDiv({cls:"vault-wizard-header"});r.createEl("h3",{text:"Add a model",cls:"vault-wizard-title"}),r.createEl("button",{cls:"vault-wizard-icon-btn vault-wizard-ghost-btn",text:"Back"}).addEventListener("click",()=>e.returnToSettingsPanel()),t.createEl("p",{cls:"vault-wizard-add-model-description",text:"Choose your AI provider to reveal the required connection fields."});let a=t.createDiv({cls:"vault-wizard-form vault-wizard-form-card"}),s=a.createDiv({cls:"vault-wizard-form-field"});s.createEl("label",{cls:"vault-wizard-form-label",text:"Model Name"});let n=s.createEl("input",{cls:"vault-wizard-form-input",attr:{type:"text",placeholder:"e.g. Main OpenAI Model"}}),d=a.createDiv({cls:"vault-wizard-form-field"});d.createEl("label",{cls:"vault-wizard-form-label",text:"AI Provider"});let l=d.createEl("select",{cls:"vault-wizard-form-select vault-wizard-provider-select"});l.createEl("option",{value:"",text:"Select provider..."}),l.createEl("option",{value:"azure",text:"Azure"}),l.createEl("option",{value:"openai",text:"OpenAI"}),l.createEl("option",{value:"anthropic",text:"Anthropic"});let c=a.createDiv({cls:"vault-wizard-form-provider-fields vault-wizard-provider-fields-card"});l.addEventListener("change",()=>{let u=l.value;if(!u){c.empty();return}x(c,u)}),a.createDiv({cls:"vault-wizard-add-model-actions"}).createEl("button",{cls:"vault-wizard-send-btn vault-wizard-add-model-save-btn",text:"Save"}).addEventListener("click",async()=>{let u=l.value,E=n.value.trim();if(!E){new w.Notice("Please enter a model name.");return}if(!u){new w.Notice("Please select an AI provider.");return}let F=$(c);await e.saveConfiguredModel({provider:u,modelName:E,settings:F}),new w.Notice("Model saved."),e.returnToSettingsPanel()})}function D(o,e){let t=o.createDiv({cls:"vault-wizard-debug-wrap"}),r=t.createDiv({cls:"vault-wizard-header"});r.createEl("h3",{text:"Debug",cls:"vault-wizard-title"}),r.createEl("button",{cls:"vault-wizard-icon-btn",text:"Back"}).addEventListener("click",()=>e.openChatPanel());let a=t.createEl("pre",{cls:"vault-wizard-debug-pre"}),s={messageCount:e.getMessages().length,streaming:e.isStreaming(),activeNotePath:e.getActiveNotePath(),configuredModels:e.getConfiguredModels().length};a.textContent=JSON.stringify(s,null,2)}function k(o,e){let t=o.createDiv({cls:"vault-wizard-settings-wrap"}),r=t.createDiv({cls:"vault-wizard-header"});r.createEl("h3",{text:"Settings",cls:"vault-wizard-title"}),r.createEl("button",{cls:"vault-wizard-icon-btn vault-wizard-ghost-btn",text:"Back"}).addEventListener("click",()=>e.openChatPanel()),t.createEl("p",{cls:"vault-wizard-settings-description",text:"Manage model connections used by the assistant."});let a=t.createDiv({cls:"vault-wizard-settings-card vault-wizard-form-card"});a.createEl("h4",{cls:"vault-wizard-settings-subtitle",text:"Available models"});let s=a.createDiv({cls:"vault-wizard-settings-list"}),n=e.getConfiguredModels();if(n.length===0)s.createDiv({cls:"vault-wizard-settings-empty",text:"No models configured yet."});else for(let c of n){let p=s.createDiv({cls:"vault-wizard-settings-row"});p.createSpan({cls:"vault-wizard-settings-provider-badge",text:c.provider}),p.createSpan({cls:"vault-wizard-settings-model-name",text:c.modelName})}t.createDiv({cls:"vault-wizard-settings-actions"}).createEl("button",{cls:"vault-wizard-send-btn vault-wizard-settings-primary-action",text:"Add a model"}).addEventListener("click",()=>e.openAddModelPanel())}function I(o,e,t){let r=o.createDiv({cls:"vault-wizard-composer"}),i=r.createEl("textarea",{cls:"vault-wizard-input",attr:{placeholder:"Type message (/c for current note content)..."}}),a=r.createEl("button",{cls:"vault-wizard-send-btn",text:t?"...":"Send"});a.disabled=t;let s=async()=>{let n=i.value;i.value="",await e(n)};a.addEventListener("click",s),i.addEventListener("keydown",async n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),await s())})}var z=require("obsidian");function N(o,e,t,r,i,a){let s=o.createDiv({cls:"vault-wizard-header"});s.createEl("h3",{text:"Vault Wizard",cls:"vault-wizard-title"});let n=s.createDiv({cls:"vault-wizard-header-actions"}),d=n.createEl("select",{cls:"vault-wizard-form-select vault-wizard-header-model-select"});if(r.length===0){let p=d.createEl("option",{value:"",text:"No models"});p.selected=!0,d.disabled=!0}else{for(let p of r){let S=`${p.provider} \u2022 ${p.modelName}`,u=d.createEl("option",{value:p.id,text:S});i&&p.id===i&&(u.selected=!0)}d.addEventListener("change",()=>{d.value&&a(d.value)})}let l=n.createEl("button",{cls:"vault-wizard-icon-btn"});l.setAttribute("aria-label","Open debug panel"),(0,z.setIcon)(l,"bug"),l.addEventListener("click",e);let c=n.createEl("button",{cls:"vault-wizard-icon-btn"});c.setAttribute("aria-label","Open settings panel"),(0,z.setIcon)(c,"settings"),c.addEventListener("click",t)}function T(o,e){let t=o.createDiv({cls:"vault-wizard-message-list"});for(let r of e)t.createDiv({cls:`vault-wizard-message vault-wizard-${r.role}`}).createDiv({cls:"vault-wizard-message-content",text:r.content});t.scrollTop=t.scrollHeight}var M=class extends W.ItemView{constructor(t,r){super(t);this.controller=r}getViewType(){return v}getDisplayText(){return"Vault Wizard Chat"}getIcon(){return"bot"}async onOpen(){this.unsubscribe=this.controller.subscribe(()=>this.render()),this.render()}async onClose(){this.unsubscribe?.()}render(){let{contentEl:t}=this;t.empty(),t.addClass("vault-wizard-root");let r=this.controller.getActivePanel();if(r==="debug"){D(t,this.controller);return}if(r==="settings"){k(t,this.controller);return}if(r==="add-model"){L(t,this.controller);return}let i=this.controller.getSelectedConfiguredModel();N(t,()=>this.controller.openDebugPanel(),()=>this.controller.openSettingsPanel(),this.controller.getConfiguredModels(),i?.id??null,a=>this.controller.selectConfiguredModelById(a)),T(t,this.controller.getMessages()),I(t,async a=>this.controller.onUserMessage(a),this.controller.isStreaming())}};var y=class extends P.Plugin{async onload(){let e=new f(this.app),t=new m,r=new h(this.app);this.controller=new g(e,t,r,A),await this.controller.initialize(),this.registerView(v,i=>new M(i,this.controller)),this.addRibbonIcon("message-square","Toggle Vault Wizard Chat",async()=>{await this.toggleChat()}),this.addCommand({id:"toggle-vault-wizard-chat",name:"Toggle Vault Wizard Chat",callback:async()=>{await this.toggleChat()}})}onunload(){this.app.workspace.detachLeavesOfType(v)}async toggleChat(){let e=this.app.workspace.getLeavesOfType(v);if(e.length>0){e.forEach(r=>r.detach());return}let t=this.app.workspace.getRightLeaf(!1);if(!t){new P.Notice("Could not open Vault Wizard panel.");return}await t.setViewState({type:v,active:!0}),this.app.workspace.revealLeaf(t)}};
